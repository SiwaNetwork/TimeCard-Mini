# Руководство по мониторингу и настройке UBX команд для модуля Ublox

## Проблема

При запуске системы Raspberry CM4 и программного обеспечения **shiwatime** навигационный модуль Ublox конфигурируется через протокол UBX при старте системы, и длительность импульса PPS устанавливается в **100 мс** вместо требуемых **5 мс**.

**Важные детали:**
- Скорость последовательного порта модуля Ublox: **9600** baud
- Конфигурирование происходит при старте системы (до запуска shiwatime)
- Сразу же после старта системы запускается сервис shiwatime

## Решение

Данное руководство описывает:
1. Как отслеживать UBX команды, отправляемые на модуль Ublox
2. Как изменить длительность импульса PPS на 5 мс (вручную, после остановки shiwatime)
3. Проблемы с автоматической настройкой и возможные решения

**⚠️ Важно:** Полностью автоматическое решение в настоящее время **недоступно** из-за того, что shiwatime перезаписывает настройки при каждом запуске и блокирует порт после запуска.

---

## Установка зависимостей

Для работы скриптов требуется библиотека `pyserial`:

```bash
sudo pip3 install pyserial
# Или через apt (если доступно)
sudo apt install python3-serial
```

---

## 1. Мониторинг UBX команд

### Использование скрипта monitor_ubx_commands.py

Скрипт позволяет отслеживать все UBX команды, отправляемые на модуль Ublox через последовательный порт.

**Важно:** Скрипт должен запускаться от имени root (sudo), так как требуется доступ к последовательному порту.

```bash
sudo python3 monitor_ubx_commands.py /dev/ttyS0 9600
```

**Параметры:**
- `/dev/ttyS0` - путь к последовательному порту модуля Ublox
- `9600` - скорость передачи (baudrate) для модуля Ublox на Raspberry CM4

### Что показывает скрипт

Скрипт выводит:
- Timestamp каждого пакета
- Класс и ID UBX сообщения
- Имя сообщения (например, CFG-TP5 для Time Pulse 5)
- Детальную информацию для CFG-TP5 сообщений:
  - Длительность импульса (в мс и нс)
  - Статус активности
  - Параметры конфигурации
- Payload пакета в hex формате

### Пример вывода

```
[14:23:15.123] UBX Packet #1
  Сообщение: CFG-TP5 (CFG-TP5)
  Класс: 0x06, ID: 0x31
  Длина payload: 32 bytes
  ⏱️  TIMEPULSE конфигурация:
     Индекс TP: 0
     Активен: True
     Длительность импульса: 100.000 мс (100000000 нс)
     Частота/Период: 1000000
     isLength: True, isFreq: False
     Полярность: LOW
     Выравнивание к TOW: True
     Задержка кабеля антенны: 0 нс
     Задержка RF группы: 0 нс
     ⚠️  ВНИМАНИЕ: Длительность импульса = 100.0 мс (требуется 5 мс)
  Payload (hex): 00000000000000006400000000000000 ...
```

### Мониторинг при запуске shiwatime

Чтобы отследить, какие команды отправляет shiwatime при запуске:

1. **Остановите shiwatime:**
```bash
sudo systemctl stop shiwatime
```

2. **Запустите монитор в одном терминале:**
```bash
sudo python3 monitor_ubx_commands.py /dev/ttyS0 9600
```

3. **В другом терминале запустите shiwatime:**
```bash
sudo systemctl start shiwatime
```

4. **Наблюдайте за UBX командами в первом терминале**

---

## 2. Изменение длительности импульса на 5 мс

### Использование скрипта configure_ublox_timepulse.py

Скрипт отправляет CFG-TP5 команду на модуль Ublox для установки длительности импульса.

**Базовое использование:**
```bash
sudo python3 configure_ublox_timepulse.py /dev/ttyS0 9600 --pulse-width-ms 5
```

**Полный синтаксис:**
```bash
sudo python3 configure_ublox_timepulse.py <port> <baudrate> [опции]
```

**Параметры:**
- `port` - путь к последовательному порту (например, `/dev/ttyS0`)
- `baudrate` - скорость передачи (для Raspberry CM4: `9600`)
- `--pulse-width-ms` - длительность импульса в миллисекундах (по умолчанию: 5.0)
- `--tp-idx` - индекс time pulse (0 или 1, по умолчанию: 0)
- `--ant-cable-delay-ns` - задержка кабеля антенны в наносекундах (по умолчанию: 0)
- `--quiet` - тихий режим (минимальный вывод)

### Примеры использования

**Установить длительность импульса 5 мс:**
```bash
sudo python3 configure_ublox_timepulse.py /dev/ttyS0 9600 --pulse-width-ms 5
```

**Установить длительность импульса 5 мс с задержкой кабеля 30 нс:**
```bash
sudo python3 configure_ublox_timepulse.py /dev/ttyS0 9600 --pulse-width-ms 5 --ant-cable-delay-ns 30
```

**Установить длительность импульса для TP1 (второй time pulse):**
```bash
sudo python3 configure_ublox_timepulse.py /dev/ttyS0 9600 --pulse-width-ms 5 --tp-idx 1
```

### Проверка результата

После выполнения скрипта вы должны увидеть:
```
✓ Подключено к /dev/ttyS0
Отправка CFG-TP5 пакета...
  Длительность импульса: 5.0 мс (5000000 нс)
✓ Конфигурация принята (ACK)
```

Если модуль отклонил команду, вы увидите:
```
✗ Конфигурация отклонена (NACK)
```

---

## 3. Сохранение конфигурации в энергонезависимую память

**Важно:** Изменения, внесенные через CFG-TP5, могут быть потеряны при перезагрузке модуля, если они не сохранены в энергонезависимую память (NV).

К сожалению, сохранение конфигурации в NV требует отправки дополнительных UBX команд (CFG-CFG), которые могут конфликтовать с конфигурацией, установленной shiwatime.

**Рекомендация:** Используйте скрипт конфигурации **после** каждого запуска shiwatime или создайте systemd service, который будет автоматически применять настройки после запуска shiwatime.

---

## 4. Автоматическое применение настроек

⚠️ **КРИТИЧЕСКАЯ ПРОБЛЕМА**

Есть **две взаимосвязанные проблемы**:

1. **Блокировка порта:** Shiwatime открывает последовательный порт `/dev/ttyS0` для монопольного доступа (exclusive access). После запуска shiwatime порт будет заблокирован, и наш скрипт не сможет подключиться к нему.

2. **Перезапись настроек:** Shiwatime при старте **перезаписывает длительность импульса на 100 мс**. Это означает, что даже если мы настроим модуль ДО запуска shiwatime, настройки будут перезаписаны при старте shiwatime.

**Вывод:** Настройка ДО запуска shiwatime **не решит проблему**, так как shiwatime все равно перезапишет настройки.

---

### Возможные решения

#### Вариант 1: Использование периодического service (Может работать)

Создать systemd timer/service, который будет периодически (например, каждые 5 минут) проверять и переустанавливать настройки. Но это требует временной остановки shiwatime, что нарушит синхронизацию времени.

**Не рекомендуется**, так как нарушает работу системы.

#### Вариант 2: Сохранение в энергонезависимую память (NV) модуля Ublox (Экспериментально)

Сохранить настройки в энергонезависимую память модуля Ublox и надеяться, что shiwatime будет использовать эти настройки. Но это может не сработать, если shiwatime явно перезаписывает настройки при каждом запуске.

**Требует тестирования.**

#### Вариант 3: Обращение к разработчикам shiwatime (Рекомендуется)

Добавить в конфигурацию shiwatime параметр для настройки длительности импульса PPS, чтобы shiwatime использовал это значение вместо жестко закодированного 100 мс.

**Это единственное правильное решение** для долгосрочного использования.

#### Вариант 4: Временное решение - настройка при каждом перезапуске

Создать service, который будет настраивать модуль ДО запуска shiwatime. Хотя shiwatime перезапишет настройки при старте, если нам нужно изменить настройки **после** перезапуска shiwatime (например, через CLI или другой интерфейс), этот service может быть полезен как промежуточное решение.

---

### Временное решение: Service для настройки ДО запуска shiwatime

Хотя shiwatime перезапишет настройки при старте, этот service может быть полезен для тестирования или как основа для дальнейших решений.

### Создание systemd service для автонастройки (ДО запуска shiwatime)

Скопируйте файл `configure-ublox-pulse-early.service` из репозитория:

```bash
sudo cp configure-ublox-pulse-early.service /etc/systemd/system/configure-ublox-pulse.service
```

Или создайте файл вручную:
```bash
sudo nano /etc/systemd/system/configure-ublox-pulse.service
```

Содержимое:
```ini
[Unit]
Description=Configure Ublox Time Pulse to 5ms (Before shiwatime)
Before=shiwatime.service
Wants=network-online.target
After=network-online.target

[Service]
Type=oneshot
# Задержка 1 секунда после доступности сети для стабилизации
ExecStartPre=/bin/sleep 1
ExecStart=/usr/bin/python3 /usr/local/bin/configure_ublox_timepulse.py /dev/ttyS0 9600 --pulse-width-ms 5 --quiet
RemainAfterExit=yes
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**Ключевое отличие:** Используется `Before=shiwatime.service` вместо `After=shiwatime.service`, чтобы сервис запускался **ДО** shiwatime и порт не был заблокирован.

**Активация сервиса:**

1. **Скопируйте скрипты в системную директорию:**
```bash
# Скопировать скрипты
sudo cp configure_ublox_timepulse.py /usr/local/bin/
sudo cp monitor_ubx_commands.py /usr/local/bin/

# Сделать исполняемыми
sudo chmod +x /usr/local/bin/configure_ublox_timepulse.py
sudo chmod +x /usr/local/bin/monitor_ubx_commands.py
```

2. **Скопируйте systemd service файл:**
```bash
# Скопировать service файл (из репозитория проекта)
sudo cp configure-ublox-pulse-early.service /etc/systemd/system/configure-ublox-pulse.service
```

3. **Активировать сервис:**
```bash
# Перезагрузить systemd
sudo systemctl daemon-reload

# Включить сервис (автозапуск при загрузке)
sudo systemctl enable configure-ublox-pulse.service

# Запустить сервис вручную для проверки
sudo systemctl start configure-ublox-pulse.service

# Проверить статус
sudo systemctl status configure-ublox-pulse.service
```

4. **Проверить логи:**
```bash
# Посмотреть логи сервиса
sudo journalctl -u configure-ublox-pulse.service -n 50

# Проверить, что конфигурация применилась
sudo systemctl status configure-ublox-pulse.service
```

**Важно:** Порядок запуска будет следующим:
1. Система загружается
2. Становится доступной сеть (network-online.target)
3. Запускается `configure-ublox-pulse.service` (настраивает модуль Ublox на 5 мс)
4. Запускается `shiwatime.service` (открывает порт, **перезаписывает настройки на 100 мс** и начинает работу)

**⚠️ ПРОБЛЕМА:** Shiwatime перезапишет настройки на 100 мс при старте, поэтому этот service **не решит проблему полностью**.

**Проверка работы:**
После перезагрузки системы проверьте, что сервис выполнился успешно:
```bash
sudo systemctl status configure-ublox-pulse.service
```

Вы должны увидеть статус `Active: active (exited)`, но помните, что shiwatime все равно перезапишет настройки.

---

---

### Рекомендации

**Текущая ситуация:** Нет простого решения, которое работало бы автоматически, так как:
- Порт блокируется shiwatime после запуска
- Shiwatime перезаписывает настройки при каждом запуске

**Рекомендуемые действия:**

1. **Краткосрочное решение:** Используйте скрипт для ручной настройки после остановки shiwatime:
   ```bash
   sudo systemctl stop shiwatime
   sudo python3 configure_ublox_timepulse.py /dev/ttyS0 9600 --pulse-width-ms 5
   sudo systemctl start shiwatime
   ```
   **Примечание:** Настройки будут перезаписаны при следующем перезапуске shiwatime.

2. **Долгосрочное решение:** Обратитесь к разработчикам shiwatime с запросом:
   - Добавить параметр конфигурации для длительности импульса PPS
   - Или добавить возможность отключить автоматическую конфигурацию time pulse

3. **Альтернативное решение:** Проверить возможность использования timebeat CLI для настройки:
   - Документация CLI: https://support.timebeat.app/hc/en-gb/articles/9168809043346-What-commands-are-available-in-the-Timebeat-CLI
   - Подключение: `ssh -p 65129 admin@127.0.0.1`
   - См. [CLI_CHECK_GUIDE.md](CLI_CHECK_GUIDE.md) для подробных инструкций по проверке CLI команд

---

## 5. Альтернативное решение: использование u-center

Если скрипты не работают или требуется более детальная настройка, можно использовать официальную программу **u-center** от u-blox.

### Установка u-center

1. Скачайте u-center с официального сайта u-blox: https://www.u-blox.com/en/product/u-center
2. Установите программу на компьютер с Windows или Linux (через Wine)

### Использование u-center

1. Подключите модуль Ublox к компьютеру (прямое подключение или через SSH-туннель)
2. Запустите u-center и выберите COM-порт
3. Перейдите в **View → Configuration View**
4. Выберите **TP (Time Pulse)** в левой панели
5. Установите:
   - **Pulse Length**: 5 мс (или 5000000 нс)
   - **Pulse Frequency**: 1 Гц
   - **Active**: включено
6. Нажмите **Send** для отправки конфигурации
7. Сохраните конфигурацию в NV: **CFG → Save current configuration → Send**

---

## 6. Диагностика проблем

### Скрипт не может подключиться к порту

**Проблема:** `Permission denied` или `Device or resource busy: [Errno 16]`

**Причина:** Порт `/dev/ttyS0` заблокирован процессом shiwatime (или другим процессом).

**Решение:**
1. **Проверьте, какой процесс использует порт:**
```bash
sudo lsof /dev/ttyS0
# Или
sudo fuser /dev/ttyS0
```

2. **Если порт используется shiwatime:**
   - Остановите shiwatime: `sudo systemctl stop shiwatime`
   - Выполните настройку: `sudo python3 configure_ublox_timepulse.py /dev/ttyS0 9600 --pulse-width-ms 5`
   - Запустите shiwatime: `sudo systemctl start shiwatime`
   
   Или используйте автоматический service с `Before=shiwatime.service` (см. раздел 4, Вариант 1)

3. **Другие причины:**
   - Убедитесь, что используете `sudo`
   - Проверьте права доступа: `ls -l /dev/ttyS0`
   - Проверьте, что порт существует: `ls -l /dev/tty*`

### Модуль отклоняет команду (NACK)

**Причины:**
- Неверные параметры команды
- Модуль заблокирован другим процессом
- Неподдерживаемые значения для данной модели модуля

**Решение:**
- Убедитесь, что модуль свободен (остановите shiwatime: `sudo systemctl stop shiwatime`)
- Используйте service с `Before=shiwatime.service` для автоматической настройки
- Проверьте документацию вашей модели модуля Ublox
- Попробуйте другие значения параметров

### Изменения не сохраняются после перезагрузки

**Причина:** Конфигурация не сохранена в энергонезависимую память, или shiwatime перезаписывает настройки при запуске.

**Решение:**
- Используйте systemd service для автоматического применения настроек (см. раздел 4)
- Обратитесь к разработчикам shiwatime для отключения автоматической конфигурации time pulse

---

## 9. Технические детали UBX протокола

### CFG-TP5 (Time Pulse 5) структура

CFG-TP5 используется для конфигурации выходов time pulse на модуле Ublox.

**Основные параметры:**
- `tpIdx`: Индекс time pulse (0 или 1)
- `pulseLenRatio`: Длительность импульса в наносекундах (если `isLength = True`)
- `freqPeriod`: Период/частота в микро-Герцах (1 Гц = 1000000 мкГц)
- `flags`: Флаги конфигурации
  - `active`: Time pulse активен
  - `isLength`: Использовать длительность вместо частоты
  - `alignToTow`: Выравнивание к Time Of Week
  - `polarity`: Полярность импульса

**Формула длительности:**
- Если `isLength = True`: `pulseLenRatio` = длительность в наносекундах
- 5 мс = 5,000,000 наносекунд

### Справочные документы

- UBX Protocol Specification: https://www.u-blox.com/en/docs/UBX-13003221
- u-blox M8 Receiver Description: https://www.u-blox.com/en/product/u-blox-m8-receiver-description

---

## Контакты и поддержка

Если у вас возникли проблемы или вопросы:
1. Проверьте логи shiwatime: `sudo journalctl -u shiwatime -n 100`
2. Проверьте документацию u-blox для вашей модели модуля
3. Обратитесь к разработчикам shiwatime/timebeat для поддержки

---

**Дата создания:** 2025-01-XX  
**Версия:** 1.0

