#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PTP Grandmaster

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PTP Grandmaster –Ω–∞ Shiwa Time"
echo "=================================================="
echo ""

echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ clock_quality –≤ –∫–æ–Ω—Ñ–∏–≥–µ:"
echo "--------------------------------------"
sudo grep -A 6 "clock_quality:" /etc/shiwatime/shiwatime.yml | grep -v "^--"
echo ""

echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞:"
echo "--------------------------------------"
sudo systemctl is-active shiwatime && echo "‚úÖ –°–µ—Ä–≤–∏—Å –ê–ö–¢–ò–í–ï–ù" || echo "‚ùå –°–µ—Ä–≤–∏—Å –ù–ï –∞–∫—Ç–∏–≤–µ–Ω"
echo ""

echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö PTP –ø–æ—Ä—Ç–æ–≤ (319, 320):"
echo "--------------------------------------"
sudo ss -ulnp | grep -E "319|320" && echo "‚úÖ PTP –ø–æ—Ä—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã" || echo "‚ùå PTP –ø–æ—Ä—Ç—ã –Ω–µ –æ—Ç–∫—Ä—ã—Ç—ã"
echo ""

echo "4Ô∏è‚É£ –ó–∞—Ö–≤–∞—Ç 5 PTP –ø–∞–∫–µ—Ç–æ–≤ (announce):"
echo "--------------------------------------"
echo "–ñ–¥–µ–º announce —Å–æ–æ–±—â–µ–Ω–∏—è (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 2 —Å–µ–∫—É–Ω–¥)..."
sudo timeout 5 tcpdump -i eth0 -nn port 320 -c 2 2>&1 | grep -E "gm clock class|time source" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å announce –ø–∞–∫–µ—Ç—ã"
echo ""

echo "5Ô∏è‚É£ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ shiwatime:"
echo "--------------------------------------"
sudo journalctl -u shiwatime -n 5 --no-pager | tail -5
echo ""

echo "=================================================="
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

