# Резюме проблемы и решений для настройки длительности импульса PPS

## Проблема

Shiwatime при запуске устанавливает длительность импульса PPS модуля Ublox в **100 мс**, в то время как требуется **5 мс**.

## Почему автоматическое решение сложно

### Проблема 1: Блокировка порта
- Shiwatime открывает `/dev/ttyS0` для монопольного доступа (exclusive access)
- После запуска shiwatime порт заблокирован для других процессов
- Невозможно подключиться к порту для отправки UBX команд

### Проблема 2: Перезапись настроек
- Shiwatime перезаписывает длительность импульса на 100 мс **при каждом запуске**
- Даже если настроить модуль ДО запуска shiwatime, настройки будут перезаписаны
- Настройки, сохраненные в энергонезависимую память модуля, также могут быть перезаписаны

## Доступные решения

### 1. Ручная настройка (Работает, но временно)

**Использование:**
```bash
# Остановить shiwatime
sudo systemctl stop shiwatime

# Настроить модуль
sudo python3 configure_ublox_timepulse.py /dev/ttyS0 9600 --pulse-width-ms 5

# Запустить shiwatime
sudo systemctl start shiwatime
```

**Ограничения:**
- Настройки перезаписываются при следующем перезапуске shiwatime
- Требуется ручное вмешательство после каждой перезагрузки

### 2. Обращение к разработчикам shiwatime (Рекомендуется)

**Запрос:** Добавить в конфигурацию shiwatime параметр для настройки длительности импульса PPS.

**Пример желаемой конфигурации:**
```yaml
timebeat:
  clock_sync:
    secondary_clocks:
      - protocol: timebeat_opentimecard_mini
        device: '/dev/ttyS0'
        baud: 9600
        card_config: ['gnss1:signal:gps+glonass']
        timepulse_pulse_width_ms: 5  # <-- Новый параметр
```

**Преимущества:**
- Настройки будут применяться автоматически при каждом запуске
- Не требует ручного вмешательства
- Интеграция в стандартный процесс конфигурации

### 3. Модификация shiwatime (Для продвинутых пользователей)

Если доступен исходный код shiwatime, можно:
- Найти место в коде, где устанавливается длительность импульса
- Изменить значение с 100 мс на 5 мс
- Пересобрать и установить модифицированную версию

**⚠️ Внимание:** Это нарушит целостность программного обеспечения и может привести к проблемам при обновлениях.

### 4. Использование timebeat CLI (Требует проверки)

Shiwatime имеет CLI интерфейс через SSH:
```bash
ssh -p 65129 admin@127.0.0.1
```

**Документация по CLI командам:**
- https://support.timebeat.app/hc/en-gb/articles/9168809043346-What-commands-are-available-in-the-Timebeat-CLI

**Проверка:**
1. Подключиться к CLI: `ssh -p 65129 admin@127.0.0.1`
2. Использовать команду `help` для просмотра доступных команд
3. Проверить, есть ли команды для настройки timepulse/pulse width
4. Если команды доступны, можно создать скрипт для автоматической настройки через CLI

## Текущий статус

- ✅ Скрипты для мониторинга UBX команд созданы
- ✅ Скрипты для настройки длительности импульса созданы
- ✅ Документация подготовлена
- ❌ Полностью автоматическое решение недоступно
- ⚠️ Требуется либо ручное вмешательство, либо модификация shiwatime

## Рекомендации

1. **Краткосрочно:** Используйте ручную настройку после остановки shiwatime
2. **Долгосрочно:** Обратитесь к разработчикам shiwatime с запросом добавить параметр конфигурации
3. **Для тестирования:** Используйте скрипты для мониторинга и проверки текущих настроек

## Контакты для обращения

- Документация shiwatime: https://shiwanetwork.tech/
- Поддержка: обратитесь к разработчикам Shiwa Network

---

**Дата создания:** 2025-01-XX  
**Статус:** Проблема идентифицирована, полное автоматическое решение требует модификации shiwatime

